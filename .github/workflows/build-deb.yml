name: Build Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build Debian package
        run: cargo deb --no-build

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: target/debian/*.deb

  publish-deb:
    name: Publish to APT Repository
    needs: build-deb
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deb artifact
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: artifacts

      - name: Setup APT repository
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mkdir -p apt-repo/pool/main/c/cte
          mkdir -p apt-repo/dists/stable/main/binary-amd64

          # 复制 .deb 文件
          cp artifacts/*.deb apt-repo/pool/main/c/cte/

          # 生成 Packages 文件
          cd apt-repo/pool/main/c/cte
          apt-ftparchive packages . > ../../../../dists/stable/main/binary-amd64/Packages
          gzip -c ../../../../dists/stable/main/binary-amd64/Packages > ../../../../dists/stable/main/binary-amd64/Packages.gz

          # 生成 Release 文件
          cd ../../..
          apt-ftparchive release dists/stable > dists/stable/Release
          gpg --default-key "your-email@example.com" -abs -o dists/stable/Release.gpg
          gpg --default-key "your-email@example.com" --clearsign -o dists/stable/InRelease dists/stable/Release

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          publish_branch: gh-pages
